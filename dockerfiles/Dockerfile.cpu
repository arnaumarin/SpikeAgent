# Use Python 3.11 as base image
FROM python:3.11-slim

# Metadata labels for GitHub Container Registry
LABEL org.opencontainers.image.source=https://github.com/arnaumarin/SpikeAgent
LABEL org.opencontainers.image.description="SpikeAgent - AI-powered assistant for spike sorting and neural data analysis"
LABEL org.opencontainers.image.licenses="See repository LICENSE file"

# Set working directory
WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    git \
    curl \
    gfortran \
    libblas-dev \
    liblapack-dev \
    libhdf5-dev \
    pkg-config \
    && rm -rf /var/lib/apt/lists/*

# Copy requirements file
COPY src/spikeagent/requirements-docker.txt /app/requirements.txt

# Install Python dependencies
# Upgrade pip first, then install requirements with retries for better ARM64 compatibility
RUN pip install --no-cache-dir --upgrade pip setuptools wheel && \
    pip install --no-cache-dir -r requirements.txt || \
    (echo "First install attempt failed, retrying..." && \
     pip install --no-cache-dir -r requirements.txt || \
     (echo "Second install attempt failed, retrying with verbose output..." && \
      pip install --no-cache-dir --verbose -r requirements.txt))

# Copy application code
COPY src /app/src

# Set PYTHONPATH to include src directory
ENV PYTHONPATH=/app/src:${PYTHONPATH}

# Create necessary directories
RUN mkdir -p history/conversation_histories_gpt \
    history/conversation_histories_gemini \
    history/conversation_histories_anthropic \
    tmp/plots

# Expose Streamlit port
EXPOSE 8501

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl --fail http://localhost:8501/_stcore/health || exit 1

# Run the application
WORKDIR /app/src/spikeagent/app
CMD ["streamlit", "run", "app.py", "--server.port=8501", "--server.address=0.0.0.0"]
